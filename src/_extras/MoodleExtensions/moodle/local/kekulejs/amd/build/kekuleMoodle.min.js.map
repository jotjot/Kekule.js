{"version":3,"file":"kekuleMoodle.min.js","sources":["../src/kekuleMoodle.js"],"sourcesContent":["define(/*'local_kekulejs/kekuleMoodle',*/ ['kekule', 'local_kekulejs/kekuleInitials'], function(){\r\n\r\n\tfunction init()\r\n\t{\r\n\t\tvar root = window;\r\n\t\tvar KekuleMoodle = {\r\n\t\t\t// Widget wrapper, which may wrap widget data in content (not attribute) of element,\r\n\t\t\tWidgetDataWrapper: {\r\n\t\t\t\tWRAPPER_HTML_CLASS: 'KekuleMoodle-Widget-Data-Wrapper',\r\n\t\t\t\tWRAPPER_DATA_HTML_CLASS: 'KekuleMoodle-Widget-Data',\r\n\r\n\t\t\t\t// only can apply to these tag names and attribs, avoid security problem\r\n\t\t\t\tALLOWED_TAGNAMES: ['div', 'span', 'img', 'p', 'section'],\r\n\t\t\t\tALLOWED_ATTRIBS: ['class', 'style', 'id', 'name', 'width', 'height', /^data-/],\r\n\r\n\t\t\t\t_matchAttribPatterns: function(attribName, patterns)\r\n\t\t\t\t{\r\n\t\t\t\t\tfor (var i = 0, l = patterns.length; i < l; ++i)\r\n\t\t\t\t\t{\r\n\t\t\t\t\t\tif (attribName.match(patterns[i]))\r\n\t\t\t\t\t\t\treturn true;\r\n\t\t\t\t\t}\r\n\t\t\t\t\treturn false;\r\n\t\t\t\t},\r\n\r\n\t\t\t\tconvertWrapperElem: function(elem, autoLaunchWidget)\r\n\t\t\t\t{\r\n\t\t\t\t\tvar content = Kekule.HtmlElementUtils.getInnerText(elem);\r\n\t\t\t\t\t//content = decodeHTMLEntities(content);\r\n\t\t\t\t\ttry\r\n\t\t\t\t\t{\r\n\t\t\t\t\t\tvar jsonObj = JSON.parse(content);\r\n\t\t\t\t\t\tif (jsonObj)\r\n\t\t\t\t\t\t{\r\n\t\t\t\t\t\t\tvar tagName = jsonObj.tagName || elem.tagName;\r\n\t\t\t\t\t\t\tif (KekuleMoodle.WidgetDataWrapper.ALLOWED_TAGNAMES.indexOf(tagName.toLowerCase()) < 0)  // tag name not allowed\r\n\t\t\t\t\t\t\t\treturn null;\r\n\r\n\t\t\t\t\t\t\t//console.log('wrapper', jsonObj);\r\n\r\n\t\t\t\t\t\t\tKekule.DomUtils.clearChildContent(elem);\r\n\t\t\t\t\t\t\tvar targetElem = elem;\r\n\t\t\t\t\t\t\tvar newCreated = false;\r\n\t\t\t\t\t\t\tif (jsonObj.tagName)  // explicit set tagName, need to create new element\r\n\t\t\t\t\t\t\t{\r\n\t\t\t\t\t\t\t\ttargetElem = elem.ownerDocument.createElement(jsonObj.tagName);\r\n\t\t\t\t\t\t\t\tnewCreated = true;\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\tfor (var attrib in jsonObj)\r\n\t\t\t\t\t\t\t{\r\n\t\t\t\t\t\t\t\tif (attrib !== 'tagName' && KekuleMoodle.WidgetDataWrapper._matchAttribPatterns(attrib, KekuleMoodle.WidgetDataWrapper.ALLOWED_ATTRIBS))\r\n\t\t\t\t\t\t\t\t{\r\n\t\t\t\t\t\t\t\t\tvar value = jsonObj[attrib];\r\n\t\t\t\t\t\t\t\t\ttargetElem.setAttribute(attrib, value);\r\n\t\t\t\t\t\t\t\t\t//console.log('set attrib', attrib, value);\r\n\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\tKekule.HtmlElementUtils.removeClass(elem, KekuleMoodle.WidgetDataWrapper.WRAPPER_HTML_CLASS);\r\n\t\t\t\t\t\t\tif (newCreated)\r\n\t\t\t\t\t\t\t\telem.appendChild(targetElem);\r\n\t\t\t\t\t\t\tif (autoLaunchWidget)\r\n\t\t\t\t\t\t\t\tKekule.Widget.autoLauncher.execute(targetElem);\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t\tcatch(e)\r\n\t\t\t\t\t{\r\n\r\n\t\t\t\t\t}\r\n\t\t\t\t},\r\n\r\n\t\t\t\t// Check elem and its children, if it is a data wrapper, convert it into widget\r\n\t\t\t\tlaunchOnElem: function(elem)\r\n\t\t\t\t{\r\n\t\t\t\t\tif (elem.isContentEditable)\r\n\t\t\t\t\t\treturn;\r\n\t\t\t\t\t// if elem already binded with a widget, do nothing\r\n\t\t\t\t\tif (Kekule.Widget.getWidgetOnElem(elem, true))  // retain placeholder\r\n\t\t\t\t\t\treturn;\r\n\t\t\t\t\t// check if elem has widget specified attribute.\r\n\t\t\t\t\tif (Kekule.HtmlElementUtils.hasClass(elem, KekuleMoodle.WidgetDataWrapper.WRAPPER_HTML_CLASS))  // is a wrapper\r\n\t\t\t\t\t{\r\n\t\t\t\t\t\tKekuleMoodle.WidgetDataWrapper.convertWrapperElem(elem, true);\r\n\t\t\t\t\t}\r\n\t\t\t\t\telse\r\n\t\t\t\t\t{\r\n\t\t\t\t\t\tvar children = Kekule.DomUtils.getDirectChildElems(elem);\r\n\t\t\t\t\t\tfor (var i = 0, l = children.length; i < l; ++i)\r\n\t\t\t\t\t\t{\r\n\t\t\t\t\t\t\tvar child = children[i];\r\n\t\t\t\t\t\t\tthis.launchOnElem(child);\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t},\r\n\r\n\t\t\t\t//\r\n\t\t\t\tlaunchOnDoc: function(doc)\r\n\t\t\t\t{\r\n\t\t\t\t\tif (!doc)\r\n\t\t\t\t\t\tdoc = document;\r\n\t\t\t\t\tKekuleMoodle.WidgetDataWrapper.launchOnElem(doc.body);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t};\r\n\r\n\t\troot.KekuleMoodle = KekuleMoodle;\r\n\r\n\t\tKekule.X.domReady(function(){\r\n\t\t\tKekuleMoodle.WidgetDataWrapper.launchOnDoc(document);\r\n\t\t});\r\n\t}\r\n\r\n\treturn {\r\n\t\t'init': function(){\r\n\t\t\t//console.log('Kekule', Kekule);\r\n\t\t\tKekule._ready(init);\r\n\t\t}\r\n\t}\r\n});"],"names":["define","init","root","window","KekuleMoodle","WidgetDataWrapper","WRAPPER_HTML_CLASS","WRAPPER_DATA_HTML_CLASS","ALLOWED_TAGNAMES","ALLOWED_ATTRIBS","_matchAttribPatterns","attribName","patterns","i","l","length","match","convertWrapperElem","elem","autoLaunchWidget","content","Kekule","HtmlElementUtils","getInnerText","jsonObj","JSON","parse","tagName","indexOf","toLowerCase","DomUtils","clearChildContent","targetElem","newCreated","attrib","ownerDocument","createElement","value","setAttribute","removeClass","appendChild","Widget","autoLauncher","execute","e","launchOnElem","isContentEditable","getWidgetOnElem","hasClass","children","getDirectChildElems","child","launchOnDoc","doc","document","body","X","domReady","_ready"],"mappings":"AAAAA,qCAA0C,CAAC,SAAU,kCAAkC,oBAE7EC,WAEJC,KAAOC,OACPC,aAAe,CAElBC,kBAAmB,CAClBC,mBAAoB,mCACpBC,wBAAyB,2BAGzBC,iBAAkB,CAAC,MAAO,OAAQ,MAAO,IAAK,WAC9CC,gBAAiB,CAAC,QAAS,QAAS,KAAM,OAAQ,QAAS,SAAU,UAErEC,qBAAsB,SAASC,WAAYC,cAErC,IAAIC,EAAI,EAAGC,EAAIF,SAASG,OAAQF,EAAIC,IAAKD,KAEzCF,WAAWK,MAAMJ,SAASC,IAC7B,OAAO,SAEF,GAGRI,mBAAoB,SAASC,KAAMC,sBAE9BC,QAAUC,OAAOC,iBAAiBC,aAAaL,cAI9CM,QAAUC,KAAKC,MAAMN,YACrBI,QACJ,KACKG,QAAUH,QAAQG,SAAWT,KAAKS,WAClCvB,aAAaC,kBAAkBG,iBAAiBoB,QAAQD,QAAQE,eAAiB,EACpF,OAAO,KAIRR,OAAOS,SAASC,kBAAkBb,UAC9Bc,WAAad,KACbe,YAAa,MAMZ,IAAIC,UALLV,QAAQG,UAEXK,WAAad,KAAKiB,cAAcC,cAAcZ,QAAQG,SACtDM,YAAa,GAEKT,WAEH,YAAXU,QAAwB9B,aAAaC,kBAAkBK,qBAAqBwB,OAAQ9B,aAAaC,kBAAkBI,iBACvH,KACK4B,MAAQb,QAAQU,QACpBF,WAAWM,aAAaJ,OAAQG,OAIlChB,OAAOC,iBAAiBiB,YAAYrB,KAAMd,aAAaC,kBAAkBC,oBACrE2B,YACHf,KAAKsB,YAAYR,YACdb,kBACHE,OAAOoB,OAAOC,aAAaC,QAAQX,aAGtC,MAAMY,MAOPC,aAAc,SAAS3B,UAElBA,KAAK4B,oBAGLzB,OAAOoB,OAAOM,gBAAgB7B,MAAM,MAGpCG,OAAOC,iBAAiB0B,SAAS9B,KAAMd,aAAaC,kBAAkBC,oBAEzEF,aAAaC,kBAAkBY,mBAAmBC,MAAM,gBAIpD+B,SAAW5B,OAAOS,SAASoB,oBAAoBhC,MAC1CL,EAAI,EAAGC,EAAImC,SAASlC,OAAQF,EAAIC,IAAKD,EAC9C,KACKsC,MAAQF,SAASpC,QAChBgC,aAAaM,SAMrBC,YAAa,SAASC,KAEhBA,MACJA,IAAMC,UACPlD,aAAaC,kBAAkBwC,aAAaQ,IAAIE,SAKnDrD,KAAKE,aAAeA,aAEpBiB,OAAOmC,EAAEC,UAAS,WACjBrD,aAAaC,kBAAkB+C,YAAYE,mBAItC,MACE,WAEPjC,OAAOqC,OAAOzD"}