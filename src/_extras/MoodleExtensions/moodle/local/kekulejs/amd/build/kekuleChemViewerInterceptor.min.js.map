{"version":3,"file":"kekuleChemViewerInterceptor.min.js","sources":["../src/kekuleChemViewerInterceptor.js"],"sourcesContent":["define(/*'local_kekulejs/kekuleChemViewerInterceptor',*/ ['kekule'], function(){\r\n\r\n\tfunction init()\r\n\t{\r\n\t\tif (typeof Kekule === 'undefined')\r\n\t\t\treturn;\r\n\r\n\t\t// utils class to intercept quiz report page\r\n\t\tvar KekuleQuizReportInterceptor = {\r\n\t\t\tmatchPage: function(document)\r\n\t\t\t{\r\n\t\t\t\tvar url = document.location.pathname.toLowerCase();\r\n\t\t\t\t//var result = url.match(/quiz\\/report.php/) || url.match(/question/);\r\n\t\t\t\tvar result = url.match('quiz') || url.match('question');\r\n\t\t\t\treturn !!result;\r\n\t\t\t},\r\n\t\t\tgetTargetElements: function(document)\r\n\t\t\t{\r\n\t\t\t\tvar result = [].concat(Array.prototype.slice.call(document.body.querySelectorAll('td[id^=\"mod-quiz-report-statistics-question-table\"]') || [], 0));\r\n\t\t\t\tresult = result.concat(Array.prototype.slice.call(document.body.querySelectorAll('div[class^=\"responsehistoryheader\"] tbody tr td') || [], 0));\r\n\t\t\t\tresult = result.concat(Array.prototype.slice.call(document.body.querySelectorAll('div[id^=\"techinfo_inner\"] p') || [], 0));\r\n\t\t\t\treturn result;\r\n\t\t\t},\r\n\t\t\t_extractMolJsonInfo: function(content)\r\n\t\t\t{\r\n\t\t\t\tvar startPos = content.indexOf('{\"');\r\n\t\t\t\tvar endPos = content.lastIndexOf('\"}');\r\n\t\t\t\tvar mayBeMolJson = (startPos >= 0) && (endPos >= content.length - 3); // end with \"} or \"};\t\t\t\tif (mayBeMolJson)\r\n\t\t\t\tif (mayBeMolJson)\r\n\t\t\t\t{\r\n\t\t\t\t\tvar nonJsonContent = content.substring(0, startPos);\r\n\t\t\t\t\tvar jsonContent = content.substring(startPos, endPos + 2);\r\n\t\t\t\t\tvar molJsonSep = '\"}; {\"';  // maybe multiple mol JSON inside\r\n\t\t\t\t\tvar jsonStrs = [];\r\n\t\t\t\t\tvar currStartPos = 0;\r\n\t\t\t\t\tvar sepPos = jsonContent.indexOf(molJsonSep, currStartPos);\r\n\t\t\t\t\twhile (sepPos >= 0)\r\n\t\t\t\t\t{\r\n\t\t\t\t\t\tvar currJsonStr = jsonContent.substring(currStartPos, sepPos + 2);\r\n\t\t\t\t\t\tjsonStrs.push(currJsonStr);\r\n\t\t\t\t\t\tcurrStartPos = sepPos + 4;\r\n\t\t\t\t\t\tsepPos = jsonContent.indexOf(molJsonSep, currStartPos);\r\n\t\t\t\t\t}\r\n\t\t\t\t\tjsonStrs.push(jsonContent.substring(currStartPos, endPos + 2));\r\n\t\t\t\t\t//console.log('jsonStrs count', jsonStrs.length);\r\n\t\t\t\t\treturn {'nonJsonContent': nonJsonContent, 'jsonContents': jsonStrs};\r\n\t\t\t\t}\r\n\t\t\t\telse\r\n\t\t\t\t{\r\n\t\t\t\t\t//console.log('non JSONStr', startPos, endPos, content.length, content);\r\n\t\t\t\t\treturn null;\r\n\t\t\t\t}\r\n\t\t\t\t//return mayBeMolJson? {'jsonContent': content.substring(startPos, endPos + 2), 'jsonPos': startPos, 'nonJsonContent': content.substring(0, startPos)}: null;\r\n\t\t\t},\r\n\t\t\thandleElement: function(element)\r\n\t\t\t{\r\n\t\t\t\tvar children = Kekule.DomUtils.getChildNodesOfTypes(element, Node.TEXT_NODE);\r\n\t\t\t\tif (children.length === 1 && !Kekule.DomUtils.getChildNodesOfTypes(element, Node.ELEMENT_NODE).length)  // only with one text node, may be the target\r\n\t\t\t\t{\r\n\t\t\t\t\tvar content = (children[0].nodeValue || '').trim();\r\n\t\t\t\t\tvar molJsonContentInfo = KekuleQuizReportInterceptor._extractMolJsonInfo(content);\r\n\t\t\t\t\t//if (content.indexOf('{') === 0 && content.lastIndexOf('}') === content.length - 1)  // wrapped with {}, possible a JSON string\r\n\t\t\t\t\tif (molJsonContentInfo)\r\n\t\t\t\t\t{\r\n\t\t\t\t\t\tKekule.DomUtils.clearChildContent(element);\r\n\t\t\t\t\t\tif (molJsonContentInfo.nonJsonContent)\r\n\t\t\t\t\t\t\tKekule.DomUtils.setElementText(element, molJsonContentInfo.nonJsonContent);\r\n\t\t\t\t\t\t// may need to create multiple viewers\r\n\t\t\t\t\t\t//let viewers = [];\r\n\t\t\t\t\t\tfor (var i = 0, l = molJsonContentInfo.jsonContents.length; i < l; ++i)\r\n\t\t\t\t\t\t{\r\n\t\t\t\t\t\t\tvar jsonStr = molJsonContentInfo.jsonContents[i];\r\n\t\t\t\t\t\t\tvar currViewer = null;\r\n\t\t\t\t\t\t\ttry\r\n\t\t\t\t\t\t\t{\r\n\t\t\t\t\t\t\t\t//var jsonObj = JSON.parse(content);\r\n\t\t\t\t\t\t\t\tvar jsonObj = JSON.parse(jsonStr);\r\n\t\t\t\t\t\t\t\tif (jsonObj && jsonObj.molData)  // has mol data field\r\n\t\t\t\t\t\t\t\t{\r\n\t\t\t\t\t\t\t\t\tvar chemObj = Kekule.IO.loadFormatData(jsonObj.molData, Kekule.IO.DataFormat.KEKULE_JSON);\r\n\t\t\t\t\t\t\t\t\tif (chemObj)  // chem object load successful, create viewer widget\r\n\t\t\t\t\t\t\t\t\t{\r\n\t\t\t\t\t\t\t\t\t\tvar viewer = new Kekule.ChemWidget.Viewer2D(element.ownerDocument);\r\n\t\t\t\t\t\t\t\t\t\tviewer.setPredefinedSetting('basic');\r\n\t\t\t\t\t\t\t\t\t\tviewer.appendToElem(element);\r\n\t\t\t\t\t\t\t\t\t\tviewer.load(chemObj);\r\n\t\t\t\t\t\t\t\t\t\tcurrViewer = viewer;\r\n\t\t\t\t\t\t\t\t\t\t//console.log('insert viewer', jsonStr);\r\n\t\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t} catch (e)\r\n\t\t\t\t\t\t\t{\r\n\t\t\t\t\t\t\t\t//console.error(e);\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\tif (!currViewer)  // not valid mol json, display text only\r\n\t\t\t\t\t\t\t{\r\n\t\t\t\t\t\t\t\tvar textNode = element.ownerDocument.createTextNode(jsonStr);\r\n\t\t\t\t\t\t\t\telement.appendChild(textNode);\r\n\t\t\t\t\t\t\t\t//console.log('none viewer', jsonStr);\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t},\r\n\t\t\texecute: function(doc)\r\n\t\t\t{\r\n\t\t\t\tif (!doc)\r\n\t\t\t\t\tdoc = document;\r\n\t\t\t\tif (KekuleQuizReportInterceptor.matchPage(doc))\r\n\t\t\t\t{\r\n\t\t\t\t\tvar targetElems = KekuleQuizReportInterceptor.getTargetElements(doc);\r\n\t\t\t\t\tif (targetElems)\r\n\t\t\t\t\t{\r\n\t\t\t\t\t\tfor (var i = targetElems.length - 1; i >= 0; --i)\r\n\t\t\t\t\t\t{\r\n\t\t\t\t\t\t\tKekuleQuizReportInterceptor.handleElement(targetElems[i]);\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t};\r\n\r\n\t\tKekule.X.domReady(KekuleQuizReportInterceptor.execute);\r\n\t}\r\n\r\n\treturn {\r\n\t\t'init': function(){\r\n\t\t\t//console.log('Kekule', Kekule);\r\n\t\t\tKekule._ready(init);\r\n\t\t}\r\n\t}\r\n});"],"names":["define","init","Kekule","KekuleQuizReportInterceptor","matchPage","document","url","location","pathname","toLowerCase","match","getTargetElements","result","concat","Array","prototype","slice","call","body","querySelectorAll","_extractMolJsonInfo","content","startPos","indexOf","endPos","lastIndexOf","length","nonJsonContent","substring","jsonContent","jsonStrs","currStartPos","sepPos","currJsonStr","push","handleElement","element","children","DomUtils","getChildNodesOfTypes","Node","TEXT_NODE","ELEMENT_NODE","nodeValue","trim","molJsonContentInfo","clearChildContent","setElementText","i","l","jsonContents","jsonStr","currViewer","jsonObj","JSON","parse","molData","chemObj","IO","loadFormatData","DataFormat","KEKULE_JSON","viewer","ChemWidget","Viewer2D","ownerDocument","setPredefinedSetting","appendToElem","load","e","textNode","createTextNode","appendChild","execute","doc","targetElems","X","domReady","_ready"],"mappings":"AAAAA,oDAAyD,CAAC,WAAW,oBAE3DC,UAEc,oBAAXC,YAIPC,4BAA8B,CACjCC,UAAW,SAASC,cAEfC,IAAMD,SAASE,SAASC,SAASC,uBAExBH,IAAII,MAAM,SAAWJ,IAAII,MAAM,cAG7CC,kBAAmB,SAASN,cAEvBO,OAAS,GAAGC,OAAOC,MAAMC,UAAUC,MAAMC,KAAKZ,SAASa,KAAKC,iBAAiB,wDAA0D,GAAI,WAE/IP,QADAA,OAASA,OAAOC,OAAOC,MAAMC,UAAUC,MAAMC,KAAKZ,SAASa,KAAKC,iBAAiB,oDAAsD,GAAI,KAC3HN,OAAOC,MAAMC,UAAUC,MAAMC,KAAKZ,SAASa,KAAKC,iBAAiB,gCAAkC,GAAI,KAGxHC,oBAAqB,SAASC,aAEzBC,SAAWD,QAAQE,QAAQ,MAC3BC,OAASH,QAAQI,YAAY,SACbH,UAAY,GAAOE,QAAUH,QAAQK,OAAS,EAElE,SACKC,eAAiBN,QAAQO,UAAU,EAAGN,UACtCO,YAAcR,QAAQO,UAAUN,SAAUE,OAAS,GAEnDM,SAAW,GACXC,aAAe,EACfC,OAASH,YAAYN,QAHR,SAG4BQ,cACtCC,QAAU,GACjB,KACKC,YAAcJ,YAAYD,UAAUG,aAAcC,OAAS,GAC/DF,SAASI,KAAKD,aACdF,aAAeC,OAAS,EACxBA,OAASH,YAAYN,QATL,SASyBQ,qBAE1CD,SAASI,KAAKL,YAAYD,UAAUG,aAAcP,OAAS,IAEpD,gBAAmBG,4BAAgCG,iBAKnD,MAITK,cAAe,SAASC,aAEnBC,SAAWnC,OAAOoC,SAASC,qBAAqBH,QAASI,KAAKC,cAC1C,IAApBJ,SAASX,SAAiBxB,OAAOoC,SAASC,qBAAqBH,QAASI,KAAKE,cAAchB,OAC/F,KACKL,SAAWgB,SAAS,GAAGM,WAAa,IAAIC,OACxCC,mBAAqB1C,4BAA4BiB,oBAAoBC,YAErEwB,mBACJ,CACC3C,OAAOoC,SAASQ,kBAAkBV,SAC9BS,mBAAmBlB,gBACtBzB,OAAOoC,SAASS,eAAeX,QAASS,mBAAmBlB,oBAGvD,IAAIqB,EAAI,EAAGC,EAAIJ,mBAAmBK,aAAaxB,OAAQsB,EAAIC,IAAKD,EACrE,KACKG,QAAUN,mBAAmBK,aAAaF,GAC1CI,WAAa,aAIZC,QAAUC,KAAKC,MAAMJ,YACrBE,SAAWA,QAAQG,QACvB,KACKC,QAAUvD,OAAOwD,GAAGC,eAAeN,QAAQG,QAAStD,OAAOwD,GAAGE,WAAWC,gBACzEJ,QACJ,KACKK,OAAS,IAAI5D,OAAO6D,WAAWC,SAAS5B,QAAQ6B,eACpDH,OAAOI,qBAAqB,SAC5BJ,OAAOK,aAAa/B,SACpB0B,OAAOM,KAAKX,SACZL,WAAaU,SAId,MAAOO,QAIJjB,WACL,KACKkB,SAAWlC,QAAQ6B,cAAcM,eAAepB,SACpDf,QAAQoC,YAAYF,eAOzBG,QAAS,SAASC,QAEZA,MACJA,IAAMrE,UACHF,4BAA4BC,UAAUsE,KAC1C,KACKC,YAAcxE,4BAA4BQ,kBAAkB+D,QAC5DC,gBAEE,IAAI3B,EAAI2B,YAAYjD,OAAS,EAAGsB,GAAK,IAAKA,EAE9C7C,4BAA4BgC,cAAcwC,YAAY3B,OAO3D9C,OAAO0E,EAAEC,SAAS1E,4BAA4BsE,gBAGxC,MACE,WAEPvE,OAAO4E,OAAO7E"}