define("qtype_kekule_chem_base/render",["kekule"],(function(){function init(){function createChemWidget(placeHolder,ansCtrlName,className,widgetType,inputType){var widgetClass,widgetProps;Kekule.ChemWidget.ComponentWidgetNames;"composer"===widgetType?(widgetClass=Kekule.Editor.Composer,(widgetProps={resizable:!0}).predefinedSetting="doc"===inputType?"fullFunc":"molOnly"):(widgetClass=Kekule.ChemWidget.Viewer,widgetProps={autoSize:!0,enableEditFromVoid:!0},"doc"===inputType?(widgetProps.restrainEditorWithCurrObj=!1,widgetProps.editorProperties={predefinedSetting:"molOnly",allowCreateNewChild:!0}):(widgetProps.restrainEditorWithCurrObj=!0,widgetProps.editorProperties={predefinedSetting:"molOnly",allowCreateNewChild:!1}),widgetProps.editorProperties.minDimension={width:450,height:350});var ctrlName,ctrlElem=(ctrlName=ansCtrlName,{answer:document.getElementsByName(ctrlName)[0]}).answer,isEmpty=!ctrlElem,jsonObj=null;if(ctrlElem){ctrlElem.style.display="none";var ansValue=ctrlElem.value;ansValue&&(jsonObj=function(answer){try{var jsonObj=JSON.parse(answer);return"object"!=typeof jsonObj?{}:jsonObj}catch(e){return{}}}(ansValue)),jsonObj&&jsonObj.molData||(isEmpty=!0)}var result=new widgetClass(placeHolder);if(result.addClassName(className),result.__answerElem__=ctrlElem,widgetProps&&result.setPropValues(widgetProps),!isEmpty){var molData=jsonObj.molData,dataType=jsonObj.molDataType||Kekule.IO.MimeType.KEKULE_JSON;try{var chemObj=Kekule.IO.loadMimeData(molData,dataType);chemObj&&result.setChemObj(chemObj)}catch(e){console.error(e)}}return widgetClass===Kekule.ChemWidget.Viewer&&result.setToolButtons([{widgetClass:Kekule.Widget.DropDownButton,htmlClass:"KM-Btn-Copy-Structure",text:Kekule.$L("KekuleMoodleTexts.CAPTION_COPY_QUESTION_STRUCTURE"),hint:Kekule.$L("KekuleMoodleTexts.HINT_COPY_QUESTION_STRUCTURE"),dropDownWidgetGetter:_btnStructureCopyDropDownPanelGetter,"#dropDown":_reactBtnCopyStructureDropdown},Kekule.ChemWidget.ComponentWidgetNames.openEditor]),widgetClass===Kekule.ChemWidget.Viewer&&result.on("load",reactViewerChemObjLoad),result}function reactViewerChemObjLoad(e){var viewer=e.currentTarget||e.target;if(viewer instanceof Kekule.ChemWidget.Viewer){var ansElem=viewer.__answerElem__;if(ansElem){var sAnswer="",molData="",smiles="",smilesNoStereo="",chemObj=viewer.getChemObj();if(chemObj)if(chemObj.isEmpty&&chemObj.isEmpty()||chemObj instanceof Kekule.ChemDocument&&chemObj.getChildCount()<=0)sAnswer="";else{try{molData=Kekule.IO.saveMimeData(chemObj,Kekule.IO.MimeType.KEKULE_JSON),smiles=Kekule.IO.saveMimeData(chemObj,Kekule.IO.MimeType.SMILES,{ignoreStereo:!1}),smilesNoStereo=Kekule.IO.saveMimeData(chemObj,Kekule.IO.MimeType.SMILES,{ignoreStereo:!0})}catch(e){}var saveObj={smiles:smiles||"",smilesNoStereo:smilesNoStereo||"",molData:molData||""};sAnswer=JSON.stringify(saveObj)}ansElem.value=sAnswer}}}function _btnStructureCopyDropDownPanelGetter(btn){var doc=btn.getDocument(),result=new KekuleMoodle.Widget.ChemObjSelectorPanel(doc);return result._questionElem=getQuestionRootElem(btn.getParent().getParent().getElement()),result.setCaption(Kekule.$L("KekuleMoodleTexts.CAPTION_COPY_QUESTION_STRUCTURE")),result.on("select",_reactStructureCopyDropDownPanelSelect),_refreshMoleculesInDropdownPanel(btn,result),result}function _reactStructureCopyDropDownPanelSelect(e){var panel=e.target,mol=e.chemObj;mol&&mol instanceof Kekule.StructureFragment&&panel._invokerViewer.setChemObj(mol.clone())}function _refreshMoleculesInDropdownPanel(btn,panel){var molecules=[],viewerBlank=btn.getParent().getParent(),questionRootElem=getQuestionRootElem(viewerBlank.getElement()),viewersInQuestion=function(elem){for(var result=[],widgets=Kekule.Widget.Utils.getWidgetsInsideElem(elem),i=0,l=widgets.length;i<l;++i)widgets[i]instanceof Kekule.ChemWidget.Viewer&&result.push(widgets[i]);return result}(questionRootElem);viewersInQuestion&&(Kekule.ArrayUtils.remove(viewersInQuestion,viewerBlank),molecules=molecules.concat(function(viewers){for(var result=[],i=0,l=viewers.length;i<l;++i){var obj=viewers[i].getChemObj();obj&&(result=result.concat(getMoleculesInChemObj(obj)))}return result}(viewersInQuestion)));for(var proxyElems=function(elem){for(var result=[],imgs=elem.getElementsByTagName("img"),i=0,l=imgs.length;i<l;++i){var img=imgs[i];"Kekule.ChemWidget.Viewer"===(img.getAttribute("data-kekule-widget")||img.getAttribute("data-widget"))&&result.push(img)}return result}(questionRootElem)||[],i=0,l=proxyElems.length;i<l;++i){var data=proxyElems[i].getAttribute("data-chem-obj");if(data){var json=JSON.parse(data),chemObj=Class.ObjSerializerFactory.getSerializer("json").load(null,json);chemObj&&(molecules=molecules.concat(getMoleculesInChemObj(chemObj)))}}panel.setObjects(molecules)}function _reactBtnCopyStructureDropdown(e){var btn=e.target,panel=btn.getDropDownWidget();panel._invokerViewer=btn.getParent().getParent();var questionElem=getQuestionRootElem(btn.getParent().getParent().getElement());questionElem!==panel._questionElem&&(panel._questionElem=questionElem,_refreshMoleculesInDropdownPanel(btn,panel))}function getQuestionRootElem(childElem){return(childElem.className||"").indexOf("que ")>=0||childElem===childElem.ownerDocument.body?childElem:getQuestionRootElem(childElem.parentNode)}function getMoleculesInChemObj(obj){var result=[],objClass=Kekule.StructureFragment;if(obj instanceof objClass)result.push(obj);else if(obj instanceof Kekule.ChemSpace){var objs=obj.filterChildren((function(child){return child&&child instanceof objClass&&child.hasCtab&&child.hasCtab()}),!0);result=result.concat(objs)}return result}Kekule.X.domReady((function(){Kekule.Editor.ChemSpaceEditorConfigs&&Kekule.Editor.ChemSpaceEditorConfigs.getInstance&&Kekule.Editor.ChemSpaceEditorConfigs.getInstance().getInteractionConfigs().setAllowUnknownAtomSymbol(!1),function(placeHolderElems){for(var i=0,l=placeHolderElems.length;i<l;++i){var placeHolder=placeHolderElems[i],className=placeHolder.getAttribute("data-widget-class"),widgetType=placeHolder.getAttribute("data-preferWidget"),ctrlName=placeHolder.getAttribute("data-name"),inputType=placeHolder.getAttribute("data-input-type");createChemWidget(placeHolder,ctrlName,className,widgetType,inputType)}}(function(){for(var result=[],elems=document.getElementsByTagName("span"),i=0,l=elems.length;i<l;++i){var className=elems[i].className;className&&className.indexOf("K-Chem-Question-Blank")>=0&&result.push(elems[i])}return result}())}))}return{init:function(){Kekule._ready(init)}}}));

//# sourceMappingURL=render.min.js.map