{"version":3,"file":"editForm.min.js","sources":["../src/editForm.js"],"sourcesContent":["/**\r\n * Created by ginger on 2016/8/19.\r\n */\r\n\r\ndefine(/*'qtype_kekule_chem_base/editForm',*/ ['kekule'], function(){\r\n\r\n\tfunction init() {\r\n\r\n\t\t/*\r\n        var QTYPE_KEKULE_CHEM_FLAG = {};\r\n\r\n        // initial function called by PHP\r\n        function _startup(Y, qtypeKekuleFlagKey, qtypeKekuleFlagValue)\r\n        {\r\n            QTYPE_KEKULE_CHEM_FLAG.Key = qtypeKekuleFlagKey;\r\n            QTYPE_KEKULE_CHEM_FLAG.Value = qtypeKekuleFlagValue;\r\n        }\r\n        */\r\n\r\n\t\tfunction findViewerPlaceHolders() {\r\n\t\t\tvar result = [];\r\n\t\t\tvar elems = document.getElementsByTagName('textarea');\r\n\t\t\tfor (var i = 0, l = elems.length; i < l; ++i) {\r\n\t\t\t\tvar className = elems[i].className;\r\n\t\t\t\tif (className && className.indexOf('K-Chem-Question-Design-AnswerBlank') >= 0)  // is a place holder\r\n\t\t\t\t{\r\n\t\t\t\t\tresult.push(elems[i]);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\treturn result;\r\n\t\t}\r\n\r\n\t\tfunction getInputType(placeHolderElems) {\r\n\t\t\tvar result = null;\r\n\t\t\tvar elem = placeHolderElems[0];\r\n\t\t\tvar form = elem && elem.form;\r\n\t\t\tif (form) {\r\n\t\t\t\tvar inputTypeElem = form.elements['inputtype'];\r\n\t\t\t\tresult = inputTypeElem && inputTypeElem.value;\r\n\t\t\t}\r\n\t\t\treturn result;\r\n\t\t}\r\n\r\n\t\tfunction createChemViewers(placeHolderElems) {\r\n\t\t\tvar inputType = getInputType(placeHolderElems);\r\n\t\t\tfor (var i = 0, l = placeHolderElems.length; i < l; ++i) {\r\n\t\t\t\tvar placeHolder = placeHolderElems[i];\r\n\t\t\t\tvar ansData = placeHolder.value;\r\n\t\t\t\tvar molData = null;\r\n\t\t\t\tvar molDataType = null;\r\n\t\t\t\tif (ansData)\r\n\t\t\t\t{\r\n\t\t\t\t\ttry\r\n\t\t\t\t\t{\r\n\t\t\t\t\t\tvar ansJSON = JSON.parse(ansData);\r\n\t\t\t\t\t\tmolData = ansJSON.molData;\r\n\t\t\t\t\t\tmolDataType = ansJSON.molDataType;\r\n\t\t\t\t\t}\r\n\t\t\t\t\tcatch (e)\r\n\t\t\t\t\t{\r\n\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t\tvar className = placeHolder.getAttribute('data-widget-class');\r\n\t\t\t\tcreateChemViewer(placeHolder, molData, molDataType, className, inputType);\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tfunction createChemViewer(placeHolder, molData, molDataType, className, inputType) {\r\n\t\t\tvar BNS = Kekule.ChemWidget.ComponentWidgetNames;\r\n\t\t\tvar placeHolderName = placeHolder.name || '';\r\n\t\t\tvar ansIndex = getAnsRelatedElemIndex(placeHolder);\r\n\t\t\tif (ansIndex >= 0) {\r\n\t\t\t\tvar widgetProps = {};\r\n\t\t\t\tif (inputType === '1')  // doc, allow input document\r\n\t\t\t\t{\r\n\t\t\t\t\twidgetProps.restrainEditorWithCurrObj = false;\r\n\t\t\t\t\twidgetProps.editorProperties = {\r\n\t\t\t\t\t\t'allowCreateNewChild': true\r\n\t\t\t\t\t};\r\n\t\t\t\t} else  // molecule\r\n\t\t\t\t{\r\n\t\t\t\t\twidgetProps.restrainEditorWithCurrObj = true;\r\n\t\t\t\t\twidgetProps.editorProperties = {\r\n\t\t\t\t\t\t'predefinedSetting': 'molOnly',\r\n\t\t\t\t\t\t'allowCreateNewChild': false\r\n\t\t\t\t\t};\r\n\t\t\t\t}\r\n\r\n\t\t\t\tvar container = document.createElement('span');\r\n\t\t\t\tvar linebreak = document.createElement('br');\r\n\t\t\t\t/*\r\n                if (molData)\r\n                    container.setAttribute('data-chem-obj', molData);\r\n                */\r\n\t\t\t\tvar parentElem = placeHolder.parentNode;\r\n\t\t\t\tparentElem.insertBefore(container, placeHolder);\r\n\t\t\t\tparentElem.insertBefore(linebreak, placeHolder);\r\n\t\t\t\t//parentElem.removeChild(placeHolder);\r\n\t\t\t\thideElem(placeHolder);\r\n\t\t\t\tvar result = new Kekule.ChemWidget.Viewer(container);\r\n\t\t\t\tresult.setPropValues(widgetProps);\r\n\t\t\t\tresult.setPredefinedSetting('editOnly').setToolButtons([BNS.loadData, BNS.saveData, BNS.openEditor])\r\n\t\t\t\t\t.setResizable(true).setEnableEditFromVoid(true);\r\n\t\t\t\tif (className)\r\n\t\t\t\t\tresult.addClassName(className);\r\n\t\t\t\tif (molData) {\r\n\t\t\t\t\tvar dataType = molDataType || Kekule.IO.MimeType.KEKULE_JSON;\r\n\t\t\t\t\ttry {\r\n\t\t\t\t\t\tvar chemObj = Kekule.IO.loadMimeData(molData, dataType);\r\n\t\t\t\t\t\tif (chemObj)\r\n\t\t\t\t\t\t\tresult.setChemObj(chemObj);\r\n\t\t\t\t\t} catch (e) {\r\n\t\t\t\t\t\tconsole.error(e);\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t\t// save input type\r\n\t\t\t\tresult.__inputType__ = inputType;\r\n\t\t\t\t// save ansIndex\r\n\t\t\t\tresult.__answerIndex__ = ansIndex;\r\n\t\t\t\tvar ansRelElems = getAnsRelatedElems(ansIndex);\r\n\t\t\t\tresult.__answerRelElems__ = ansRelElems;\r\n\t\t\t\tresult.on('load', reactChemObjLoad);\r\n\t\t\t\treturn result;\r\n\t\t\t} else\r\n\t\t\t\treturn null;\r\n\t\t}\r\n\r\n\t\tfunction reactChemObjLoad(e) {\r\n\t\t\tvar viewer = e.currentTarget || e.target;\r\n\t\t\tif (viewer instanceof Kekule.ChemWidget.Viewer)  // avoid event invoked by composer\r\n\t\t\t{\r\n\t\t\t\tvar viewerElem = viewer.getElement();\r\n\t\t\t\t/*\r\n                var ansIndex = viewer.__answerIndex__;\r\n                var ansRelElems = getAnsRelatedElems(ansIndex);\r\n                */\r\n\t\t\t\tvar ansRelElems = viewer.__answerRelElems__;\r\n\t\t\t\t//var molDataElem = ansRelElems.molData;\r\n\t\t\t\t//var smilesElem = ansRelElems.smiles;\r\n\t\t\t\tvar answerElem = ansRelElems.answer;\r\n\t\t\t\tif (/*molDataElem && smilesElem &&*/ answerElem) {\r\n\t\t\t\t\tvar molData = '', smiles = '', smilesNoStereo = '';\r\n\t\t\t\t\tvar chemObj = viewer.getChemObj();\r\n\t\t\t\t\tif (chemObj) {\r\n\t\t\t\t\t\tvar sAnswer = '';\r\n\t\t\t\t\t\tif ((chemObj.isEmpty && chemObj.isEmpty()) || ((chemObj instanceof Kekule.ChemDocument) && (chemObj.getChildCount() <= 0)))  // a empty chem object/document\r\n\t\t\t\t\t\t{\r\n\t\t\t\t\t\t\tsAnswer = '';\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\telse if (!chemObj.isEmpty())\r\n\t\t\t\t\t\t{\r\n\t\t\t\t\t\t\ttry\r\n\t\t\t\t\t\t\t{\r\n\t\t\t\t\t\t\t\tmolData = Kekule.IO.saveMimeData(chemObj, Kekule.IO.MimeType.KEKULE_JSON);\r\n\t\t\t\t\t\t\t\tsmiles = Kekule.IO.saveMimeData(chemObj, Kekule.IO.MimeType.SMILES, {'ignoreStereo': false});\r\n\t\t\t\t\t\t\t\tsmilesNoStereo = Kekule.IO.saveMimeData(chemObj, Kekule.IO.MimeType.SMILES, {'ignoreStereo': true});\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\tcatch (e)\r\n\t\t\t\t\t\t\t{\r\n\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\tvar saveObj = {\r\n\t\t\t\t\t\t\t\t'smiles': smiles,\r\n\t\t\t\t\t\t\t\t'smilesNoStereo': smilesNoStereo,\r\n\t\t\t\t\t\t\t\t'molDataType': Kekule.IO.MimeType.KEKULE_JSON,\r\n\t\t\t\t\t\t\t\t'molData': molData\r\n\t\t\t\t\t\t\t};\r\n\t\t\t\t\t\t\tsAnswer = JSON.stringify(saveObj);\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\telse\r\n\t\t\t\t\t\t\tsAnswer = '';\r\n\t\t\t\t\t}\r\n\t\t\t\t\t//molDataElem.value = molData;\r\n\t\t\t\t\t//smilesElem.value = smiles;\r\n\t\t\t\t\tanswerElem.value = sAnswer;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tfunction getAnsRelatedElemIndex(elem) {\r\n\t\t\tvar result = -1;\r\n\t\t\tvar name = elem.name;\r\n\t\t\tvar matchResult = name.match(/\\[(\\d+)\\]/);\r\n\t\t\tif (matchResult) {\r\n\t\t\t\tresult = parseInt(matchResult[1]);\r\n\t\t\t}\r\n\t\t\treturn result;\r\n\t\t}\r\n\r\n\t\tfunction getAnsRelatedElems(ansIndex) {\r\n\t\t\treturn {\r\n\t\t\t\t//'molData': document.getElementsByName('moldata[' + ansIndex + ']')[0],\r\n\t\t\t\t//'smiles': document.getElementsByName('smiles[' + ansIndex + ']')[0],\r\n\t\t\t\t'answer': document.getElementsByName('answer[' + ansIndex + ']')[0]\r\n\t\t\t};\r\n\t\t}\r\n\r\n\t\tfunction hideElem(elem) {\r\n\t\t\telem.style.display = 'none';\r\n\t\t}\r\n\r\n\t\tfunction init() {\r\n\t\t\t// avoid student to input unwanted pseudo atoms\r\n\t\t\tif (Kekule.Editor.ChemSpaceEditorConfigs && Kekule.Editor.ChemSpaceEditorConfigs.getInstance) {\r\n\t\t\t\tvar editorConfigs = Kekule.Editor.ChemSpaceEditorConfigs.getInstance();\r\n\t\t\t\teditorConfigs.getInteractionConfigs().setAllowUnknownAtomSymbol(false);\r\n\t\t\t}\r\n\r\n\t\t\tvar placeHolders = findViewerPlaceHolders();\r\n\t\t\tcreateChemViewers(placeHolders);\r\n\t\t}\r\n\r\n\t\tKekule.X.domReady(init);\r\n\r\n\t}\r\n\r\n\treturn {\r\n\t\t'init': function(){\r\n\t\t\tKekule._ready(init);\r\n\t\t}\r\n\t}\r\n\r\n});"],"names":["define","init","createChemViewer","placeHolder","molData","molDataType","className","inputType","BNS","Kekule","ChemWidget","ComponentWidgetNames","ansIndex","name","elem","result","matchResult","match","parseInt","getAnsRelatedElemIndex","widgetProps","restrainEditorWithCurrObj","editorProperties","container","document","createElement","linebreak","parentElem","parentNode","insertBefore","style","display","Viewer","setPropValues","setPredefinedSetting","setToolButtons","loadData","saveData","openEditor","setResizable","setEnableEditFromVoid","addClassName","dataType","IO","MimeType","KEKULE_JSON","chemObj","loadMimeData","setChemObj","e","console","error","__inputType__","__answerIndex__","ansRelElems","getElementsByName","getAnsRelatedElems","__answerRelElems__","on","reactChemObjLoad","viewer","currentTarget","target","getElement","answerElem","answer","smiles","smilesNoStereo","getChemObj","sAnswer","isEmpty","ChemDocument","getChildCount","saveMimeData","SMILES","saveObj","JSON","stringify","value","X","domReady","Editor","ChemSpaceEditorConfigs","getInstance","getInteractionConfigs","setAllowUnknownAtomSymbol","placeHolderElems","form","inputTypeElem","elements","getInputType","i","l","length","ansData","ansJSON","parse","getAttribute","createChemViewers","elems","getElementsByTagName","indexOf","push","findViewerPlaceHolders","_ready"],"mappings":"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"}